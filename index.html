<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مولد فاتورة — LIGEER</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --main:#0b1320;
      --accent:#d94b2b;
      --muted:#666;
      --bg:#f4f6f8;
    }
    body{
      font-family: 'Tajawal', sans-serif;
      background:var(--bg);
      margin:0;
      padding:24px;
      color:var(--main);
      -webkit-font-smoothing:antialiased;
    }
    .container{
      max-width:900px;
      margin:0 auto;
    }
    .form-panel, .preview-panel{
      background:#fff;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(10,20,30,.06);
      padding:18px;
      margin-bottom:18px;
    }
    h2{ margin:6px 0 14px; font-weight:700; }
    label{ display:block; margin:10px 0 6px; font-weight:600; color:var(--muted); }
    input[type="text"], input[type="tel"], input[type="date"], input[type="number"], textarea{
      width:100%;
      padding:10px;
      border:1px solid #e6e9ee;
      border-radius:8px;
      box-sizing:border-box;
      font-size:14px;
      background:#fcfdff;
    }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:150px; }
    .btn {
      display:inline-block;
      padding:10px 14px;
      border-radius:8px;
      background:var(--main);
      color:#fff;
      cursor:pointer;
      border:none;
      font-weight:700;
      margin-top:12px;
      transition:0.3s;
    }
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    .btn.secondary{ background:#666; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; }

    /* الفاتورة */
    .invoice{
      width:100%;
      max-width:210mm;
      margin:0 auto;
      padding:24px;
      background:#fff;
      color:var(--main);
      border-radius:6px;
      box-sizing:border-box;
      direction:rtl;
      opacity:0;
      transform:translateY(20px);
      animation:fadeSlide 0.8s forwards;
    }
    @keyframes fadeSlide{
      to{
        opacity:1;
        transform:translateY(0);
      }
    }
    .invoice .header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .brand { text-align:right; }
    .brand img.logo{
      width:80px;
      height:auto;
      display:block;
      margin-bottom:6px;
      border-radius:8px;
      transition: transform 0.5s ease, opacity 0.5s ease;
      background:white; /* خلفية بيضاء للشعار الشفاف */
      padding:4px;
    }
    .brand h1{ margin:0; font-size:30px; letter-spacing:2px; }
    .brand p{ margin:6px 0 0; color:var(--muted); font-size:14px; }
    .meta { text-align:left; font-size:13px; color:var(--muted); }
    .divider{ height:1px; background:#eee; margin:12px 0; }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      border:1px solid #e6e9ee;
      border-radius:8px;
      overflow:hidden;
    }
    th, td{ padding:12px 10px; text-align:right; }
    th{
      font-weight:600;
      color:#555;
      background:#f8f9fa;
    }
    td{
      background:#fff;
      border-bottom:1px solid #f0f0f0;
    }
    .right { text-align:left; }
    .totals { margin-top:8px; display:flex; justify-content:flex-end; gap:10px; }
    .totals .box { width:260px; background:#f8f9fa; padding:12px; border-radius:8px; font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,0.03); }
    .footer{ margin-top:18px; display:flex; justify-content:space-between; align-items:center; font-size:13px; color:var(--muted); }
    .contact { text-align:right; }
  </style>
</head>
<body>
  <div class="container">
    <div class="form-panel">
      <h2>مولد فاتورة — LIGEER</h2>

      <div class="row">
        <div class="col">
          <label>اسم المتجر</label>
          <input id="shop_name" type="text" value="LIGEER المتجر الإلكتروني">
        </div>
        <div class="col">
          <label>البريد الإلكتروني</label>
          <input id="shop_email" type="text" value="ligeer.lr@gmail.com">
        </div>
        <div class="col">
          <label>هاتف المتجر</label>
          <input id="shop_phone" type="tel" value="+966537022394">
        </div>
      </div>

      <label>عنوان المتجر</label>
      <input id="shop_address" type="text" value="Bani Malik, King Fahd Branch Road, جدة 23331, السعودية">

      <div class="row">
        <div class="col">
          <label>اسم العميل</label>
          <input id="customer_name" type="text" value="فيصل الشريف">
        </div>
        <div class="col">
          <label>هاتف العميل</label>
          <input id="customer_phone" type="tel" value="+966551525544">
        </div>
        <div class="col">
          <label>عنوان العميل</label>
          <input id="customer_address" type="text" value="جدة - حي النسيم">
        </div>
        <div class="col">
          <label>رقم الفاتورة</label>
          <input id="invoice_no" type="text" value="184481794">
        </div>
        <div class="col">
          <label>تاريخ</label>
          <input id="invoice_date" type="date" value="2025-05-18">
        </div>
      </div>

      <hr style="border:none;height:1px;background:#eee;margin:12px 0">

      <h3>منتجات</h3>
      <div id="items_wrapper"></div>
      <button class="btn secondary" onclick="addItem()">أضف منتج</button>

      <div style="margin-top:14px;" class="controls">
        <button class="btn" onclick="renderPreview()">تحديث المعاينة</button>
        <button class="btn" onclick="downloadPDF()">تحميل PDF</button>
        <button class="btn secondary" onclick="downloadImage()">تحميل صورة</button>
        <button class="btn secondary" onclick="printPreview()">طباعة</button>
      </div>
    </div>

    <div class="preview-panel">
      <h2>معاينة الفاتورة</h2>
      <div id="invoice_preview" class="invoice">
        <img id="logo_img" src="" class="logo" alt="LIGEER Logo">
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
    const defaultItems = [
      {desc:'مق صغير + طباعة أمام وخلف', qty:4, price:35},
      {desc:'مق كبير + طباعة أمام وخلف', qty:4, price:35}
    ];

    function addItem(item){
      const wrapper=document.getElementById('items_wrapper');
      const data=item||{desc:'',qty:1,price:0};
      const row=document.createElement('div');
      row.style.display='flex';row.style.gap='8px';row.style.marginTop='8px';
      row.innerHTML=`
        <input class="item_desc" placeholder="الوصف" value="${data.desc}" style="flex:1;padding:8px;border-radius:6px;border:1px solid #e9eef3" />
        <input class="item_qty" type="number" min="1" value="${data.qty}" style="width:80px;padding:8px;border-radius:6px;border:1px solid #e9eef3" />
        <input class="item_price" type="number" min="0" value="${data.price}" style="width:110px;padding:8px;border-radius:6px;border:1px solid #e9eef3" />
        <button onclick="removeItem(this)" style="background:#ff6464;color:#fff;border:none;padding:8px;border-radius:6px;cursor:pointer">حذف</button>`;
      wrapper.appendChild(row);
    }

    function removeItem(btn){ btn.parentElement.remove(); }

    async function loadLogoBase64(url){
      const res = await fetch(url);
      const blob = await res.blob();
      return new Promise((resolve)=>{
        const reader = new FileReader();
        reader.onloadend = ()=>resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    let logoBase64 = '';
    loadLogoBase64('https://www2.0zz0.com/2025/10/15/15/879728691.jpg').then(data=>{
      logoBase64 = data;
      renderPreview();
    });

    window.addEventListener('DOMContentLoaded',()=>{defaultItems.forEach(it=>addItem(it));});

    function gatherData(){
      return {
        shop_name:shop_name.value,
        shop_email:shop_email.value,
        shop_phone:shop_phone.value,
        shop_address:shop_address.value,
        customer_name:customer_name.value,
        customer_phone:customer_phone.value,
        customer_address:customer_address.value,
        invoice_no:invoice_no.value,
        invoice_date:invoice_date.value,
        items:Array.from(document.querySelectorAll('#items_wrapper>div')).map(div=>({
          desc:div.querySelector('.item_desc').value,
          qty:+div.querySelector('.item_qty').value||0,
          price:+div.querySelector('.item_price').value||0
        }))
      };
    }

    function renderPreview(){
      const d=gatherData();let subtotal=0;
      const rows=d.items.map(it=>{
        const total=it.qty*it.price;subtotal+=total;
        return `<tr><td style="width:50%">${it.desc}</td><td>${it.qty}</td><td class="right">${it.price.toFixed(2)} SAR</td><td class="right">${total.toFixed(2)} SAR</td></tr>`;
      }).join('');

      document.getElementById('logo_img').src = logoBase64;

      invoice_preview.innerHTML = `
        <div class="header">
          <div class="brand">
            <img src="${logoBase64}" class="logo" alt="LIGEER Logo">
            <h1>LIGEER</h1>
            <p>${d.shop_name}</p>
            <p style="margin-top:6px;font-size:13px;color:var(--muted)">${d.shop_address}</p>
          </div>
          <div class="meta">
            <div><strong>فاتورة #</strong> ${d.invoice_no}</div>
            <div style="margin-top:6px"><strong>التاريخ:</strong> ${d.invoice_date}</div>
            <div style="margin-top:6px"><strong>هاتف المتجر:</strong> ${d.shop_phone}</div>
            <div style="margin-top:6px"><strong>البريد:</strong> ${d.shop_email}</div>
          </div>
        </div>
        <div class="divider"></div>
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div style="text-align:right">
            <div><strong>مصدرة إلى:</strong></div>
            <div style="margin-top:6px">${d.customer_name}</div>
            <div style="margin-top:6px;color:var(--muted)">${d.customer_phone}</div>
            <div style="margin-top:6px;color:var(--muted)">${d.customer_address}</div>
          </div>
          <div style="text-align:left;color:var(--muted);font-size:13px">
            <div>تفاصيل الطلب</div>
          </div>
        </div>
        <div style="margin-top:14px">
          <table><thead><tr><th>الوصف</th><th>الكمية</th><th class="right">سعر الوحدة</th><th class="right">الإجمالي</th></tr></thead><tbody>${rows}</tbody></table>
        </div>
        <div class="totals">
          <div class="box">
            <div style="display:flex;justify-content:space-between"><span>مجموع السلة</span><span>${subtotal.toFixed(2)} SAR</span></div>
            <div style="display:flex;justify-content:space-between;margin-top:8px"><span>إجمالي الطلب</span><span>${subtotal.toFixed(2)} SAR</span></div>
          </div>
        </div>
        <div class="footer">
          <div class="contact">
            <div><strong>بيانات التواصل</strong></div>
            <div style="margin-top:6px">${d.shop_name}</div>
            <div style="margin-top:4px">${d.shop_phone}</div>
            <div style="margin-top:4px">${d.shop_email}</div>
          </div>
          <div style="text-align:left">
            <div>شكراً لشرائك من المتجر. نتمنى لك يوماً رائعاً.</div>
          </div>
        </div>`;
    }

    function downloadPDF(){
      renderPreview();
      const element=document.getElementById('invoice_preview');
      html2pdf().set({
        margin:10,
        filename:(invoice_no.value||'invoice')+'.pdf',
        image:{type:'jpeg',quality:1},
        html2canvas:{scale:1.4,useCORS:true,backgroundColor:"#ffffff"},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
      }).from(element).save();
    }

    async function downloadImage(){
      renderPreview();
      const element=document.getElementById('invoice_preview');
      const canvas=await html2canvas(element,{scale:2,useCORS:true,backgroundColor:"#ffffff"});
      const imgData=canvas.toDataURL("image/jpeg",1.0);
      const link=document.createElement("a");
      link.href=imgData;
      link.download=(invoice_no.value||'invoice')+".jpg";
      link.click();
    }

    function printPreview(){
      renderPreview();
      const w=window.open('','_blank');
      w.document.write('<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>طباعة الفاتورة</title><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet"><style>body{font-family:Tajawal,sans-serif;margin:24px}</style></head><body>');
      w.document.write(invoice_preview.outerHTML);
      w.document.write('</body></html>');
      w.document.close();w.focus();setTimeout(()=>w.print(),600);
    }
  </script>
</body>
</html>
